@{
    ViewBag.Title = "Series";
    ViewBag.Section = "Configuración";
    Layout = "~/Views/_Layout.cshtml";
}
@section styles_link {
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.13/css/dataTables.bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/1.2.4/css/buttons.dataTables.min.css" />
    @Html.StyleLink("css/plugins/chosen/bootstrap-chosen.css")
}

@section scripts_link {
    <script src="https://cdn.datatables.net/1.10.13/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.13/js/dataTables.bootstrap.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.2.4/js/dataTables.buttons.min.js"></script>
    @Html.JavaScriptLink("js/plugins/chosen/chosen.jquery.js")
    <script>
        var table = $('#clientsTable').DataTable();
        
        var tiposFac;
        var tiposDoc = getDocuments();
        

        console.log("**dasda");
        console.log(tiposDoc);
        //Cargar Tipos de Factura y Tipos de Documento
        //TEST
        var tiposFac = [
         { "Value": 1, "Content": "Factura" },
         { "Value": 2, "Content": "Boleta" },
         { "Value": 3, "Content": "Nota de debito" }
        ];
        
        function getDocuments() {
            var returnResult;
            $.ajax({method: "GET", url: "/Finantial/Settings/DocumentTypes" })
            .done(function (result) {

                var objResult = jQuery.parseJSON(result);
                returnResult = objResult;

                //console.log(result);
                //console.log(objResult);
                }).fail(function (result) {
                    returnResult = null;
                });
            return returnResult;
        }

        /*
        var tiposDoc = [
         { "Value": 1, "content": "Factura" },
         { "Value": 2, "content": "Boleta" },
         { "Value": 3, "content": "Nota de debito" }
        ];*/

        function ConvertFormToJSON(form) {
            var array = jQuery(form).serializeArray();
            var json = {};

            jQuery.each(array, function () {
                json[this.name] = this.value || '';
            });
            return json;
        }


        $(document).on('click', '.editSerie', function () {
            var parentRow = $(this).closest('tr');
            var parentContainer = $(this).parent();

            load_edit_modal(parentRow, parentContainer);

            $("#clientsTable tr.selected").removeClass("selected");
            parentRow.addClass("selected");

            $("#editShowSerieForm input").prop("disabled", false);
            $("#endEdit").prop("disabled", true);

            $(".editBtn").removeClass("hidden");
            $("#modalViewTitle").html("Editar serie");
        });

        $(document).on('click', '.showSerie', function () {
            var parentRow = $(this).closest('tr');
            var parentContainer = $(this).parent();

            load_edit_modal(parentRow, parentContainer);

            $("#editShowSerieForm input").prop("disabled", true);

            $(".editBtn").addClass("hidden");
            $("#modalViewTitle").html("Visualizar serie");
        });

        $(document).on('change', '#defaultCheckboxEdit', function () {
            if ($(this).is(":checked"))
                $("#defaultEdit").val("true");
            else
                $("#defaultEdit").val("false");
        });
        //EDITAR SERIE
        $(document).on('click', '#editAcBtn', function () {
            var jsonSerie = ConvertFormToJSON("#editShowSerieForm");
            edit_row(jsonSerie);
            $.ajax({ method: "POST", url: "/Finantial/Settings/InvoiceDocuments_Populate", data: { documentType: jsonSerie.DocumentType, id: jsonSerie.Id, current: jsonSerie.Current, max: jsonSerie.Max, min: jsonSerie.Min, default: jsonSerie.Default, digital: jsonSerie.Digital } })
              .done(function (result) {
                edit_row(jsonSerie);
              })
              .fail(function (result) {
            });
        });
        //ELIMINAR SERIE
        $(document).on('click', '.deleteSerie', function () {
            var parentRow = $(this).closest('tr');
            var inicio = parentRow.find('.inicioSerie').text();
            var actual = parentRow.children('td').eq(3).text();
            if (inicio == actual) {
                parentRow.addClass("selected");
                table.row('.selected').remove().draw(false);
            }
            else {
                $("#deleteAlert").fadeIn("fast", function () {
                    $("#deleteAlert").removeClass("hidden");
                });
                setTimeout(function () {
                    $("#deleteAlert").fadeOut("slow", function () {
                        $("#deleteAlert").addClass("hidden");
                    });
                }, 5000);
            }
        });

        $(document).on('change', '#feSelect', function () {
            $("#fe").val($("#feSelect").val());
        });

        $(document).on('change', '#typeSelect', function () {
            $("#type").val($("#typeSelect").val());
        });

        $(document).on('change', '#feSelectEdit', function () {
            $("#feEdit").val($("#feSelectEdit").val());
        });

        $(document).on('change', '#typeSelectEdit', function () {
            $("#typeEdit").val($("#typeSelectEdit").val());
        });

        createSelects("#feSelect", "#typeSelect");
        createSelects("#feSelectEdit", "#typeSelectEdit");

        function createSelects(fe, type) {
            var feSelect = $(fe);
            var typeSelect = $(type);

            feSelect.append("<option value='0' selected disabled>Elige tipo de facturación</option>");
            typeSelect.append("<option value='0' selected disabled>Elige tipo de documento</option>");

            //AÑADIR AJAX QUE RECIBE LOS TIPOS DE DOCUMENTO Y DE FACTURACION

            $.each(tiposFac, function (i, item) {
                feSelect.append($('<option>', {
                    value: item.Value,
                    text: item.Content
                }));
            });
            /*
            $.each(tiposDoc, function (i, item) {
                console.log("************");
                console.log(item.Value);
                console.log(item.Content);
                console.log("************");
                typeSelect.append($('<option>', {
                    value: item.Value,
                    text: item.Content
                }));
            });*/

        }

        function searchValue(content, array) {
            var returnValue;
            $.each(array, function (i, item) {
                if (content == item.Content) {
                    returnValue = item.Value;
                }
            });
            return returnValue;
        }

        function load_edit_modal(parentRow, parentContainer) {
            //Modificar!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
            var fe = searchValue(parentRow.children('td').eq(0).text(), tiposFac);
            var type = searchValue(parentRow.children('td').eq(1).text(), tiposDoc);

            $("#feEdit").val(fe);
            $("#typeEdit").val(type);

            var selectFeCustom = '#feSelectEdit option[value=' + fe + ']';
            var selectTypeCustom = '#typeSelectEdit option[value=' + type + ']';

            $('#feSelectEdit option').prop("selected", false);
            $('#typeSelectEdit option').prop("selected", false);

            $(selectFeCustom).prop("selected", true);
            $(selectTypeCustom).prop("selected", true);

            $("#serieEdit").val(parentRow.children('td').eq(2).text());
            $("#currentEdit").val(parentRow.children('td').eq(3).text());

            if (parentRow.children('td').eq(4).text() == "Sí") {
                $("#defaultCheckboxEdit").prop('checked', true);
                $("#defaultEdit").val("true");
            }
            else {
                $("#defaultCheckboxEdit").prop('checked', false);
                $("#defaultEdit").val("false");
            }

            $("#startEdit").val(parentContainer.find('.inicioSerie').text());
            $("#endEdit").val(parentContainer.find('.finSerie').text());
        }

        function edit_row(jsonSerie) {
            var parentRow = $(".selected");
            var parentContainer = $(".selected td:last");

            var checkbox = jsonSerie.Default == "true" ? '<div class="text-center pointerNone"><input type="checkbox" checked="true" disabled></div>' : '<div class="text-center pointerNone"><input type="checkbox" disabled></div>';

            parentRow.children('td').eq(0).text(jsonSerie.DocumentType);
            parentRow.children('td').eq(1).text(jsonSerie.InvoiceType);
            parentRow.children('td').eq(2).text(jsonSerie.Id);
            parentRow.children('td').eq(3).text(jsonSerie.Count);
            parentRow.children('td').eq(4).html(checkbox);

            parentContainer.find('.inicioSerie').text(jsonSerie.MinCount);
        }
    </script>
}

@section section_script {
    var table = $('#clientsTable').DataTable();
          table.search( '' ).columns().search( '' ).draw();
    
            var tiposFac;
            var tiposDoc;

            $.ajax({ method: "GET", url: "/Finantial/Settings/DocumentTypes" })
                .done(function (result) {
                    
                    var objResult = jQuery.parseJSON(result);
                    tiposDoc = objResult;
                    //console.log(result);
                    //console.log(objResult);
                }).fail(function (result) {
            });
            //Cargar Tipos de Factura y Tipos de Documento
            //TEST
            var tiposFac = [
             { "Value": 1, "Content": "Factura" },
             { "Value": 2, "Content": "Boleta" },
             { "Value": 3, "Content": "Nota de debito" }
            ];

          $('[data-toggle="tooltip"]').tooltip();

          $("#clientsTable_wrapper").children('div').eq(0).addClass("hidden");

          //populate_series();

          $("#defaultCheckbox").change(function(){
            if($(this).is(":checked"))
              $("#default").val("true");
            else
              $("#default").val("false");
          });

          //Creates new Serie
          $("#createSerie").click(function(){
            var jsonSerie = ConvertFormToJSON("#createSerieForm");
            var jsonSerieArray = [];
            jsonSerieArray.push(jsonSerie);

            $.ajax({ method: "POST", url: "/Finantial/Settings/AddSeries", data: { documentType: jsonSerie.DocumentType, id: jsonSerie.Id, current: jsonSerie.Current, max: jsonSerie.Max, min: jsonSerie.Min, default: jsonSerie.Default, digital: jsonSerie.Digital  } })
              .done(function (result){
                add_series(jsonSerieArray);
              }).fail(function (result){
            });
          });

          $("#btnClean").click(function()
            {
            $("#clientsTable > tbody").empty();
            });

          $("#myBtn").click(function()
            {
                var json = [{
                    "Digital": "true","DocumentType": "DOC 1","Id": "SERIE 1","Current": "ACTUAL 1","Default": "true","Min": "INICIO 1", "Max": "FIN"}, {"Digital": "FAC 2","DocumentType": "DOC 2","Id": "SERIE 2","Current": "ACTUAL 2","Default": "false","Min": "INICIO 1", "Max": "FIN"}, {"Digital": "FAC 3","DocumentType": "DOC 3","Id": "SERIE 3","Current": "ACTUAL 3","Default": "true","Min": "INICIO 1", "Max": "FIN"}];
            add_series(json);
          });

          //modificar!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
          function searchContent(value, array){
            var returnValue;
            $.each(array, function(i, item) {
              if(value == item.Value){
                returnValue = item.Content;
              }
            });
            return returnValue;
          }

          function testing_load(){
            var json = [{"Digital": "false","DocumentType": "1","Id": "SERIE 1","Current": "ACTUAL 1","Default": "true","Min": "INICIO 1", "Max": "FIN"}, {"Digital": "2","DocumentType": "2","Id": "SERIE 2","Current": "ACTUAL 2","Default": "false","Min": "INICIO 1", "Max": "FIN"}, {"Digital": "3","DocumentType": "3","Id": "SERIE 3","Current": "ACTUAL 3","Default": "true","Min": "INICIO 1", "Max": "FIN"}];
            add_series(json);
          }

          function add_series(json){
            $.each(json, function (index, value) {
              var billingType = value.Digital;
              var type = value.DocumentType;
              var serie = value.Id;
              var current = value.Current;
              var def = value.Default;
              var start = value.Min;
              var end = value.Max;

              //Modificar!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
              var tipoFac = searchContent(billingType,tiposFac);
              var tipoDoc = searchContent(type,tiposDoc);

              var defaultSymbol = def == "true" ? '<div class="text-center pointerNone"><input type="checkbox" checked="true" disabled></div>' : '<div class="text-center pointerNone"><input type="checkbox" disabled></div>';
              table.row.add( [
                tipoFac,
                tipoDoc,
                serie,
                current,
                defaultSymbol,
                '<td><div class="text-center"><span class="hidden inicioSerie">' + start + '</span><span class="hidden finSerie">' + end + '</span><button class="btn btn-info btn-xs showSerie actionBtn" data-toggle="modal" href="modal-form" data-target="#modalEditar" type="button" data-toggle="tooltip" data-placement="top" title="Ver"><i class="fa fa-search"></i></button><button class="btn btn-warning btn-xs editSerie actionBtn" data-toggle="modal" href="modal-form" data-target="#modalEditar" type="button" data-toggle="tooltip" data-placement="top" title="Editar"><i class="fa fa-pencil"></i></button><button class="btn btn-danger btn-xs deleteSerie actionBtn" type="button" data-toggle="tooltip" data-placement="top" title="Eliminar"><i class="fa fa-trash"></i></button></div></td>'
              ] ).draw(false);

            });
          }

          //Load all data into the table
          function populate_series() {
            $.ajax({ method: "GET", url: "/Finantial/Settings/InvoiceDocuments_Populate" })            
                .done(function (result) {
                    var objResult = jQuery.parseJSON(result);                    
                    add_series(objResult);
                }).fail(function (result) {
            });
    }
    

}

<div id="deleteAlert" class="alert alert-danger alert-dismissable hidden" style="margin-top: 10px;">
    <button aria-hidden="true" data-dismiss="alert" class="close" type="button">×</button>
    <span>No se puede eliminar una serie que esté en uso</span>
</div>

<div class="row">
    <div class="col-lg-12">
        <div class="ibox float-e-margins">
            <div class="ibox-title">
                <h5>Tabla de Series</h5>
                <div class="ibox-tools">
                    <a>
                        <a class="btn btn-primary" data-toggle="modal" data-target="#modalInsert">Agregar nueva serie</a>
                    </a>
                </div>
            </div>
            <div class="ibox-content">
                <div class="table-responsive">


                    <table id="clientsTable" class="table table-striped table-bordered table-hover dataTables-example">
                        <thead>
                        <tr>
                            <th>Tipo de Facturacion</th>
                            <th>Tipo de Documento</th>
                            <th>Serie</th>
                            <th>Actual</th>
                            <th>Default</th>
                            <th>Acciones</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

	 <!-- Modal Insert-->
<div class="modal fade" id="modalInsert" role="dialog">
    <div class="modal-dialog">
        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Insertar</h4>
            </div>
            <div class="modal-body">
                <div class="ibox-content">
                    <div class="row">
                        <div>
                            <form id="createSerieForm" role="form">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label> Tipo de Facturación </label>
                                            <input id="fe" class="form-control required hidden" name="DocumentType">
                                            <select id="feSelect" class="form-control m-b"></select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label> Tipo de Documento </label>
                                            <input id="type" class="form-control required hidden" name="InvoiceType">
                                            <select id="typeSelect" class="form-control m-b"></select>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label> Número de Serie </label>
                                            <input id="serie" class="form-control required" name="Id">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label> Inicio </label>
                                            <input id="start" class="form-control required" name="MinCount">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label> Fin </label>
                                            <input id="end" class="form-control required" name="MaxCount">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label> Actual </label>
                                            <input id="current" class="form-control required" name="Count">
                                        </div>
                                    </div>
                                </div>
                                <div class="checkbox">
                                    <label><input id="defaultCheckbox" class="required checkbox checkbox-primary" type="checkbox" value="" checked="false">Serie a usar por defecto</label>
                                </div>
                                <input id="default" type="text" name="Default" hidden value="true">
                                <div class="modal-footer">
                                    <button id="createSerie" type="submit" class="btn btn-default" data-dismiss="modal">Aceptar</button>
                                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>






<!-- Modal Edit -->
<div class="modal fade" id="modalEditar" role="dialog">
    <div class="modal-dialog">
        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 id="modalViewTitle" class="modal-title"></h4>
            </div>
            <div class="modal-body">
                <div class="ibox-content">
                    <div class="row">
                        <div>
                            <form id="editShowSerieForm" role="form">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label> Tipo de Facturación </label>
                                            <input id="feEdit" class="form-control required hidden" name="DocumentType">
                                            <select id="feSelectEdit" class="form-control m-b"></select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label> Tipo de Documento </label>
                                            <input id="typeEdit" class="form-control required hidden" name="InvoiceType">
                                            <select id="typeSelectEdit" class="form-control m-b"></select>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label> Número de Serie </label>
                                            <input id="serieEdit" class="form-control required" name="Id">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label> Inicio </label>
                                            <input id="startEdit" class="form-control required" name="MinCount">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label> Fin </label>
                                            <input id="endEdit" class="form-control required" name="MaxCount">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label> Actual </label>
                                            <input id="currentEdit" class="form-control required" name="Count">
                                        </div>
                                    </div>
                                </div>
                                <div class="checkbox">
                                    <label><input id="defaultCheckboxEdit" class="required checkbox checkbox-primary" type="checkbox" value="" checked="false">Serie a usar por defecto</label>
                                </div>
                                <input id="defaultEdit" type="text" name="Default" hidden value="true">
                                <div class="modal-footer">
                                    <button id="editAcBtn" type="submit" class="btn btn-default editBtn" data-dismiss="modal">Aceptar</button>
                                    <button id="editCancBtn" type="button" class="btn btn-default editBtn" data-dismiss="modal">Cancelar</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">

</script>
